<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>CodeSpitz75-2</title>
</head>
<body>
  <img id="a"/>
  <div id="b"></div>
  <img id="c"/>
  <div id="d"></div>
<script>
const el = v => document.querySelector(v);
const baseUrl = Symbol.for('baseUrl of router');
const Service = class {
  constructor () {
    this._repoMap = new Map;
  }
}
const GithubService = class extends Service {
  constructor () {
    super();
  }
  addRepo (key, id, repo) {
    if (typeof key !== 'string' || typeof id !== 'string' || typeof repo !== 'string') throw new Error('Invalid argument');
    const router = new Map;
    router.base = `https://api.github.com/repos/${id}/${repo}/contents/`;
    this._repoMap.set(key, router)
  }
  addRouter (key, ext, o) {
    if (!this._repoMap.has(key)) throw new Error('Not added repo');
    if (typeof ext !== 'string') throw new Error('Invalid ext');
    if (!o instanceof Loader) throw new Error('Invalid loader');

    const router = this._repoMap.get(key);
    ext.split(',').forEach(v => router.set(v, o));
  }
  load (key, path, el) {
    if (!this._repoMap.has(key)) throw new Error('Not supported repo');
    if (typeof path !== 'string') throw new Error('Invalid path');
    const router = this._repoMap.get(key);
    const {base} = router
     
    const id = `callback${GithubService._id++}`;
    const s = document.createElement('script');
    s.src = `${base}${path}?callback=GithubService.${id}`;
    document.head.appendChild(s);

    GithubService[id] = ({data: {content}}) => {
      delete GithubService[id];
      document.head.removeChild(s);
      const ext = path.split('.').pop();
      const parser = router.get(ext);
      if (!parser) throw new Error('Not supported extention');
      parser.load(el, content);
    }
  }
}
GithubService._id = 0

const Loader = class {
  load (el, content) { throw new Error('Must be overrided'); }
}

const ImageLoader = class extends Loader {
  load (el, content) {
    el.src = `data:text/plain;base64,${content}`;
  }
}
const MDLoader = class extends Loader {
  load (el, content) {
    const d64 = v => decodeURIComponent(atob(v).split('').map(c => '%' + ('00' +c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    const parseMD = v => {
      return d64(v)
        .split('\n')
        .map(v => {
          for (let i = 3; i > 0; i--) {
            if(v.startsWith('#'.repeat(i))) return `<h${i}>${v.substr(i)}</h${i}>`;
          }
          return v
        })
        .join('<br>');
      }
    el.innerHTML = parseMD(content);
  }
}

const Builder = class {
  constructor () {
    
  }
  getService () {
    throw new Error('Must be overrided');
  }
}
const GithubServiceBuilder = class extends Builder {
  constructor (key, id, repo) {
    super();
    const strategyForExt = [
      {'jpg,png,gif': new ImageLoader},
      {'md': new MDLoader}
    ]
    const githubService = new GithubService();
    githubService.addRepo(key, id, repo);
    strategyForExt.forEach(obj => Object.entries(obj).forEach(([ext, strategy]) => githubService.addRouter(key, ext, strategy)));
    this._githubService = githubService;
  }
  getService () {
    return this._githubService;
  }
}

const githubServiceBuilder = new GithubServiceBuilder('sinrok', 'fresh502', 'design_pattern');
const github = githubServiceBuilder.getService();

github.load('sinrok', 'husky.png', el('#a'));
github.load('sinrok', 'README.md', el('#b'));
// github.load('s75', 'einBig.png', el('#c'));
// github.load('s75', 'README.md', el('#d'));
</script>
</body>
</html>