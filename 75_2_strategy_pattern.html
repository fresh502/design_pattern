<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>CodeSpitz75-2</title>
</head>
<body>
  <img id="a"/>
  <div id="b"></div>
<script>
const el = v => document.querySelector(v)
const d64 = v => decodeURIComponent(atob(v).split('').map(c => '%' + ('00' +c.charCodeAt(0).toString(16)).slice(-2)).join(''));
const parseMD = v => {
  return d64(v)
    .split('\n')
    .map(v => {
      for (let i = 3; i > 0; i--) {
        if(v.startsWith('#'.repeat(i))) return `<h${i}>${v.substr(i)}</h${i}>`;
      }
      return v
    })
    .join('<br>')
}

const Github = class {
  constructor (id, repo) {
    this._base = `https://api.github.com/repos/${id}/${repo}/contents/`;
  }
  setParser (f, ...args) {
    this._parser = [f, args];
  }
  load (path) {
    const id = `callback${Github._id++}`;
    const s = document.createElement('script');
    Github[id] = ({data: {content}}) => {
      delete Github[id];
      document.head.removeChild(s);
      const el = this._parser[1][0];
      this._parser[0](content, el);
    }
    return new Promise((resolve, reject) => {
      s.src = `${this._base}${path}?callback=Github.${id}`;
      document.head.appendChild(s);
      s.onload = () => resolve();
      s.onerror = () => reject();
    });
  }
}
Github._id = 0

const Loader = class {
  constructor (id, repo) {
    this._git = new Github(id, repo);
    this._router = new Map;
  }
  add (ext, f, ...args) {
    ext.split(',').forEach(v => this._router.set(v, [f, args]));
  }
  async load (v) {
    const {_router: router, _git: git} = this;
    const ext = v.split('.').pop();
    if (!router.has(ext)) throw new Error('Not supported extension');
    const [f, args] = router.get(ext);
    git.setParser(f, ...args);
    await git.load(v);
  }
}

const img = (v, el) => el.src = `data:text/plain;base64,${v}`;
const md = (v, el) => el.innerHTML = parseMD(v);

(async () => {
  const loader = new Loader('hikaMaeng', 'codespitz75');
  loader.add('jpg,png,gif', img, el('#a'));
  loader.add('md', md, el('#b'));
  await loader.load('einBig.png');
  await loader.load('README.md');
})();
</script>
</body>
</html>